# Coraza WAF Configuration
# Basic WAF configuration with security rules

# Enable rules engine
SecRuleEngine On

# Request body handling
# Limit set to ~12.5MB to balance security and functionality
# Adjust based on your application's needs (file uploads, API payloads, etc.)
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072

# Response body handling
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 524288

# File upload handling
# Note: These directories will be created in the container at runtime
# In production, consider using persistent volumes with restricted permissions
SecTmpDir /tmp/coraza/
SecDataDir /tmp/coraza/

# Logging
SecAuditEngine RelevantOnly
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /dev/stdout

# Debug log
SecDebugLog /dev/stdout
SecDebugLogLevel 0

# Generic attack detection using Coraza's built-in operators
SecRule REQUEST_HEADERS|ARGS|ARGS_NAMES "@detectSQLi" \
    "id:1001,phase:2,block,log,msg:'SQL Injection Attack Detected'"

SecRule REQUEST_HEADERS|ARGS|ARGS_NAMES "@detectXSS" \
    "id:1002,phase:2,block,log,msg:'XSS Attack Detected'"

# Block common security scanners by User-Agent with word boundaries
SecRule REQUEST_HEADERS:User-Agent "@rx (?i)\b(nikto|sqlmap|nmap|masscan|nessus|openvas|acunetix|burp)\b" \
    "id:1003,phase:1,deny,log,msg:'Known Security Scanner Detected',status:403"

# Block access to sensitive paths - anchored to beginning of URI
SecRule REQUEST_URI "@rx ^/(admin|config|backup|tmp|logs|wp-admin|\.env|\.git|\.htaccess|\.htpasswd|\.ssh|\.aws|web\.config)(/|$)" \
    "id:1004,phase:1,deny,log,msg:'Access to sensitive path blocked',status:403"

# Common attack patterns - XSS
SecRule ARGS "@rx (?i)<script[^>]*>.*?</script>" \
    "id:1005,phase:2,block,log,msg:'Potential XSS Script Tag in Arguments',status:403"

# Common attack patterns - SQL Injection (enhanced with comments and procedure calls)
SecRule ARGS "@rx (?i)(union.*?select|insert.*?into|delete.*?from|drop.*?table|update.*?set|exec.*?\(|execute.*?\(|sp_|xp_|--|/\*)" \
    "id:1006,phase:2,block,log,msg:'SQL Injection Pattern Detected',status:403"

# Path traversal protection - comprehensive encoding variations
SecRule REQUEST_URI|ARGS "@rx (\.\.(/|\\|%2f|%5c|%2F|%5C|%2e%2f|%2e%5c|%2E%2F|%2E%5C|%252e%252e|%252E%252E))|(%2e%2e|%2E%2E)" \
    "id:1007,phase:2,block,log,msg:'Path Traversal Attempt Detected',status:403"

# Null byte injection
SecRule REQUEST_URI|ARGS|REQUEST_HEADERS "@rx \x00" \
    "id:1008,phase:2,block,log,msg:'Null Byte Injection Detected',status:403"
