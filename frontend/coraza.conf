# Coraza WAF Configuration
# Basic WAF configuration with security rules

# Enable rules engine
SecRuleEngine On

# Request body handling
# Request body limits:
# - File uploads: ~12.5MB (SecRequestBodyLimit 13107200)
# - Non-file payloads (JSON, form data): 512KB (SecRequestBodyNoFilesLimit 524288)
# Adjust based on your application's needs (file uploads, API payloads, etc.)
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 524288

# Response body handling
# Disabled since no response body inspection rules are configured
# Enable if you plan to add response body inspection rules in the future
# When enabled, configure SecResponseBodyMimeType and SecResponseBodyLimit
SecResponseBodyAccess Off

# File upload handling
# Directories are created in the Dockerfile with OpenShift-compatible permissions (770, GID 0)
# In production, consider using persistent volumes with restricted permissions
SecTmpDir /tmp/coraza/
SecDataDir /tmp/coraza/

# Logging
# RelevantOnly: Only logs transactions that trigger rules or cause errors
# This reduces log volume but means allowed requests won't have audit trails
# For full audit trails (compliance), use SecAuditEngine On with log rotation
SecAuditEngine RelevantOnly
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /dev/stdout

# Debug log (disabled in production with level 0)
SecDebugLog /dev/stdout
SecDebugLogLevel 0

# Generic attack detection using Coraza's built-in operators
SecRule REQUEST_HEADERS|ARGS|ARGS_NAMES "@detectSQLi" \
    "id:1001,phase:2,block,log,msg:'SQL Injection Attack Detected'"

SecRule REQUEST_HEADERS|ARGS|ARGS_NAMES "@detectXSS" \
    "id:1002,phase:2,block,log,msg:'XSS Attack Detected'"

# Block common security scanners by User-Agent with word boundaries
# Note: Burp Suite is excluded to allow authorized security testing
SecRule REQUEST_HEADERS:User-Agent "@rx (?i)\b(nikto|sqlmap|nmap|masscan|nessus|openvas|acunetix)\b" \
    "id:1003,phase:1,deny,log,msg:'Known Security Scanner Detected',status:403"

# Block access to sensitive paths - anchored to beginning of URI
# This intentionally blocks common paths targeted by attackers (/.env, /.git, /admin, etc.)
# The pattern matches both /path and /path/ for comprehensive protection
# If your application legitimately uses any of these paths, whitelist them using:
#   SecRuleRemoveById 1004
#   SecRule REQUEST_URI "@rx ^/your-legitimate-path" "id:1004,phase:1,pass"
# Or modify this rule to exclude specific paths from the block list
SecRule REQUEST_URI "@rx ^/(admin|config|backup|tmp|logs|wp-admin|\.env|\.git|\.htaccess|\.htpasswd|\.ssh|\.aws|web\.config)(/|$)" \
    "id:1004,phase:1,deny,log,msg:'Access to sensitive path blocked',status:403"

# Common attack patterns - SQL Injection (enhanced with comments and procedure calls)
# Uses word boundaries and whitespace requirements to reduce false positives
# SQL comment patterns: --(\s|$) matches comments with whitespace or end of string
# /\*[^*]*\*+/ matches SQL block comments (safer regex to prevent ReDoS)
SecRule ARGS "@rx (?i)(union\s+select|insert\s+into|delete\s+from|drop\s+table|update\s+set|exec\s*\(|execute\s*\(|\bsp_|\bxp_|--(\s|$)|/\*[^*]*\*+/)" \
    "id:1005,phase:2,block,log,msg:'SQL Injection Pattern Detected',status:403"

# Path traversal protection - comprehensive encoding variations
SecRule REQUEST_URI|ARGS "@rx (?i)(\.\.(/|\\|%2f|%5c)|(%2e%2e|%252e%252e)(/|\\|%2f|%5c))" \
    "id:1007,phase:2,block,log,msg:'Path Traversal Attempt Detected',status:403"

# Null byte injection
SecRule REQUEST_URI|ARGS|REQUEST_HEADERS "@rx \x00" \
    "id:1008,phase:2,block,log,msg:'Null Byte Injection Detected',status:403"
