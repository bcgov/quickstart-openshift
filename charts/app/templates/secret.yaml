{{- if and .Values.global.secrets .Values.global.secrets.enabled }}
{{- $databaseUser := .Values.global.config.databaseUser }}
{{- if not $databaseUser }}
  {{- fail "ERROR: global.config.databaseUser is required when secrets are enabled" }}
{{- end }}

{{- $databasePassword := printf "" }}
{{- $host := printf "" }}
{{- $databaseName := printf "" }}
{{- $hostWithoutPort := printf "" }}
{{- $pgbouncerUrl := printf "" }}
{{- $secretName := printf "%s-pguser-%s" .Values.global.databaseAlias .Values.global.config.databaseUser }}

{{- $secretObj := (lookup "v1" "Secret" .Release.Namespace $secretName ) }}
{{- $secretData := (and $secretObj (get $secretObj "data")) }}

{{- if and $secretObj $secretData }}

{{- $databasePassword = get $secretData "password" }}
{{- if not $databasePassword }}
  {{- fail (printf "ERROR: Cluster secret '%s' exists but 'password' field is missing" $secretName) }}
{{- end }}
{{- $databaseName = b64dec (get $secretData "dbname") }}
{{- if not $databaseName }}
  {{- fail (printf "ERROR: Cluster secret '%s' exists but 'dbname' field is missing" $secretName) }}
{{- end }}
{{- $pgbouncerUrl = b64dec (get $secretData "pgbouncer-uri") }}
{{- if not $pgbouncerUrl }}
  {{- fail (printf "ERROR: Cluster secret '%s' exists but 'pgbouncer-uri' field is missing" $secretName) }}
{{- end }}
{{- $hostData := (get $secretData "host") }}
{{- if not $hostData }}
  {{- fail (printf "ERROR: Cluster secret '%s' exists but 'host' field is missing" $secretName) }}
{{- end }}
{{- $portData := (get $secretData "port") }}
{{- if not $portData }}
  {{- fail (printf "ERROR: Cluster secret '%s' exists but 'port' field is missing" $secretName) }}
{{- end }}
{{- $host = printf "%s:%s" (b64dec $hostData) (b64dec $portData) }}
{{- $hostWithoutPort = printf "%s" (b64dec $hostData) }}
{{- $databaseURL := printf "postgresql://%s:%s@%s/%s" $databaseUser (b64dec $databasePassword) $host $databaseName }}
{{- $databaseJDBCURL := printf "jdbc:postgresql://%s:%s@%s/%s" $databaseUser (b64dec $databasePassword) $host $databaseName }}
{{- $databaseJDBCURLNoCreds := printf "jdbc:postgresql://%s/%s" $host $databaseName }}

{{- else }}

{{- $databasePassword = .Values.global.secrets.databasePassword }}
{{- if not $databasePassword }}
  {{- fail "ERROR: Cluster secret not found and global.secrets.databasePassword is required (must pass via Helm values)" }}
{{- end }}
{{- $databaseName = .Values.global.secrets.databaseName }}
{{- if not $databaseName }}
  {{- fail "ERROR: Cluster secret not found and global.secrets.databaseName is required (must pass via Helm values)" }}
{{- end }}
{{- $databaseHost := .Values.global.secrets.databaseHost }}
{{- if not $databaseHost }}
  {{- fail "ERROR: Cluster secret not found and global.secrets.databaseHost is required (must pass via Helm values)" }}
{{- end }}
{{- $pgbouncerUrl = .Values.global.secrets.databasePgbouncerUrl }}
{{- if not $pgbouncerUrl }}
  {{- fail "ERROR: Cluster secret not found and global.secrets.databasePgbouncerUrl is required (must pass via Helm values)" }}
{{- end }}
{{- $databasePort := .Values.global.secrets.databasePort | default "5432" }}
{{- $host = printf "%s:%s" $databaseHost $databasePort }}
{{- $hostWithoutPort = printf "%s" $databaseHost }}
{{- $databaseURL := printf "postgresql://%s:%s@%s/%s" $databaseUser $databasePassword $host $databaseName }}
{{- $databaseJDBCURL := printf "jdbc:postgresql://%s:%s@%s/%s" $databaseUser $databasePassword $host $databaseName }}
{{- $databaseJDBCURLNoCreds := printf "jdbc:postgresql://%s/%s" $host $databaseName }}

---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-backend
  labels: {{- include "labels" . | nindent 4 }}
  {{- if .Values.global.secrets.persist }}
  annotations:
    helm.sh/resource-policy: keep
  {{- end }}
data:
  POSTGRES_PASSWORD: {{ $databasePassword | quote }}
  POSTGRES_USER: {{ $databaseUser | b64enc | quote }}
  POSTGRES_DATABASE: {{ $databaseName | b64enc | quote }}
  POSTGRES_HOST: {{ $hostWithoutPort | b64enc | quote }}
  PGBOUNCER_URL: {{ $pgbouncerUrl | b64enc | quote }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-flyway
  labels: {{- include "labels" . | nindent 4 }}
  {{- if .Values.global.secrets.persist }}
  annotations:
    helm.sh/resource-policy: keep
  {{- end }}
data:
  FLYWAY_URL: {{ $databaseJDBCURLNoCreds | b64enc | quote }}
  FLYWAY_USER: {{ $databaseUser | b64enc | quote }}
  FLYWAY_PASSWORD: {{ $databasePassword | quote }}
{{- end }}

{{- end }}
